<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create an AWS Lambda function with lambdar • lambdar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Create an AWS Lambda function with lambdar">
<meta property="og:description" content="lambdar">
<meta property="og:image" content="https://lewinfox.github.io/lambdar/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">lambdar</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0.9005</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/lambdar.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lewinfox/lambdar/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="lambdar_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Create an AWS Lambda function with lambdar</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/lewinfox/lambdar/blob/master/vignettes/lambdar.Rmd"><code>vignettes/lambdar.Rmd</code></a></small>
      <div class="hidden name"><code>lambdar.Rmd</code></div>

    </div>

    
    
<p>In this article we will walk through the process of creating and deploying an R function in AWS Lambda using the <code>lambdar</code> package.</p>
<p>AWS Lambda does not currently provide a pre-packaged runtime for R. However, it does allow you to create lambda functions that use a custom Docker image. The goal of <code>lambdar</code> is to make creating these Docker images as easy as possible so you can focus on the code rather than the infrastructure.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>You will need:</p>
<ul>
<li>An AWS account</li>
<li>Docker</li>
<li>R</li>
</ul>
<p>These are not strictly necessary but will make your life easier:</p>
<ul>
<li>RStudio</li>
<li>The AWS cli</li>
</ul>
</div>
<div id="create-your-function" class="section level2">
<h2 class="hasAnchor">
<a href="#create-your-function" class="anchor"></a>Create your function</h2>
<p>In RStudio, create a new project. I’m calling mine <code>lambdar-test</code>.</p>
<p>Once you have the project open, create a file <code>main.R</code> and add a function called <code>hello_world()</code>. Using roxygen-style comments, tag the function with <code>@lambda</code>. This tells lambdar’s build system that you want to deploy this function.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># main.R</span>

<span class="co">#' @lambda</span>
<span class="va">hello_world</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"World"</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello, "</span>, <span class="va">name</span>, <span class="st">"!"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>At the moment your project will look pretty boring.</p>
<pre><code>.
├── lambdar-test.Rproj
└── main.R</code></pre>
</div>
<div id="initialise-lambdar" class="section level2">
<h2 class="hasAnchor">
<a href="#initialise-lambdar" class="anchor"></a>Initialise lambdar</h2>
<p>Call <code><a href="../reference/use_lambdar.html">lambdar::use_lambdar()</a></code>. This does a number of things:</p>
<p>First, it creates a <code>.lambdar/</code> directory in your project. Next, it writes a file in that directory called <code>lambdar_runtime.R</code>. The runtime is a script that passes incoming requests from AWS to your code, and returns the results of your code to AWS so they can be passed on to your users. Changing this file could cause things to break, so leave it alone unless you know what you’re doing.</p>
<p>Next, <code>lambdar</code> scans all the <code>.R</code> files in your project looking for functions with the <code>@lambda</code> tag. This is so it knows which files need to be included in your container. It will also try and detect any R packages your function needs by looking for <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> and <code>package::function()</code> calls in your code.</p>
<p>Once this is done, <code>lambdar</code> writes a <code>_lambdar.yml</code> configuration file to your project directory, This is the template that will be used to create a Dockerfile, which in turn will be used to create a container image. If this doesn’t make sense to you I suggest Googling “intro to Docker”.</p>
<p>Your project now looks something like this:</p>
<pre><code>.
├── .lambdar
│   └── lambdar_runtime.R
├── lambdar-test.Rproj
├── _lambdar.yml
└── main.R</code></pre>
</div>
<div id="lambdar-yml" class="section level2">
<h2 class="hasAnchor">
<a href="#lambdar-yml" class="anchor"></a><code>_lambdar.yml</code>
</h2>
<p><code>_lambdar.yml</code> contains all the information needed to create your container images. If you open it, you’ll see that some information has been pre-filled for you:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># This will be used as the container tag</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">app_name</span><span class="kw">:</span><span class="at"> </span><span class="st">"lewin/lambdar-test"</span></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># What version of R should be installed in the container?</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="fu">r_version</span><span class="kw">:</span><span class="at"> </span><span class="st">"4.1.0"</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># List of files or directories that need to be added to the container image</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="fu">include_files</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> </span><span class="st">"main.R"</span><span class="at"> </span><span class="kw">]</span></span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co"># Specify the handler/s as `file.function_name`. Omit `.R` from the file name.</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="fu">lambda_handlers</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> </span><span class="st">"main.hello_world"</span><span class="at"> </span><span class="kw">]</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co"># List any extra R packages you need to have installed in the container</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="fu">r_packages</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">  </span><span class="kw">]</span></span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co"># List any extra Linux packages you need to have installed in the container</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="fu">linux_packages</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">  </span><span class="kw">]</span></span>
<span id="cb4-18"><a href="#cb4-18"></a></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co"># Specify any environment variables your function needs.</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co">#</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: Do not use YAML lists here. Copy the syntax in the example variables below.</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Support `env` being a list as well as this syntax</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="at">  </span><span class="fu">LAMBDAR_APP_NAME</span><span class="kw">:</span><span class="at"> </span><span class="st">"lewin/lambdar-test"</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="at">  </span><span class="fu">LAMBDAR_VERSION</span><span class="kw">:</span><span class="at"> </span><span class="st">"0.1.0"</span></span></code></pre></div>
<div id="parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#parameters" class="anchor"></a>Parameters</h3>
<ul>
<li>
<code>app_name</code>: What do you want your container to be called? This is arbitrary - the default name is <code>&lt;your_username&gt;/&lt;name_of_project_folder&gt;</code>. This parameter doesn’t affect the contents of the container at all, but it will be used as the Docker tag (see docker build -t).</li>
<li>
<code>r_version</code>: What version of R do you want installed in the container? The default is whatever version of R you’re currently running. If you want to specify a different version, enter it as <code>"major.minor.patch"</code>, e.g. <code>"3.6.3"</code>.</li>
<li>
<code>include_files</code>: This is a list of files that need to be copied into the container. <code>lambdar</code> has populated this as best it can by looking for files that contain functions tagged with <code>@lambdar</code>, but if your code needs any other files (for example, if you’re <code><a href="https://rdrr.io/r/base/source.html">source()</a></code>-ing any other files or if you need to include data files), list them here. At the moment <code>lambdar</code> does not support files nested within folders - although the files will be copied over, the directory structure will be lost and everything will end up in the same directory in the container. Although it’s messy, keep all your code and data files in your project’s root directory.</li>
<li>
<code>lambda_handlers</code>: Each lambda instance calls a single function. We need to tell AWS where to find that function, which we do by feeding it a handler string in the format <code>"file.function_name"</code>. Note that there is no <code>.R</code> in the filename and no <code>()</code> at the end of the function name. Make sure that your handler functions don’t contain any characters other than letters, numbers and underscores.</li>
<li>
<code>r_packages</code>: A list of any additional R packages that your function requires. <code>lambdar</code> will have filled this in as best it can, but if you need anything else, enter the names here.</li>
<li>
<code>linux_packages</code>: If your function needs any additional Linux libraries, mention them here. <code>lambdar</code> does not give you any help here! If you omit a required package here you will encounter errors when building the Dockerfile in the next step.</li>
<li>
<code>env</code>: A list of environment variables to be set in the container. <code>_lambdar.yml</code> contains two, <code>LAMBDAR_APP_NAME</code> and <code>LAMBDAR_VERSION</code> - these are not used by anything at the moment and are just there to demonstrate the syntax.</li>
</ul>
<p>At this point you can manually edit <code>_lamndar.yml</code> if you need to, but for our example we will move on to creating the Dockerfile.</p>
</div>
</div>
<div id="create-the-dockerfile" class="section level2">
<h2 class="hasAnchor">
<a href="#create-the-dockerfile" class="anchor"></a>Create the <code>Dockerfile</code>
</h2>
<p>Run <code><a href="../reference/build_dockerfile.html">lambdar::build_dockerfile()</a></code>. This starts from a basic <code>Dockerfile</code> and adds in any additional customisations set out in <code>_lambdar.yml</code>. The resulting <code>Dockerfile</code> will be written to your project’s root directory, so you should have something that looks like this:</p>
<pre><code>.
├── .lambdar
│   └── lambdar_runtime.R
├── Dockerfile
├── lambdar-test.Rproj
├── _lambdar.yml
└── main.R</code></pre>
<p>At this point you can edit the Dockerfile yourself if you want to make any further changes, but for this example we will keep things simple and move on to building the container.</p>
</div>
<div id="build-the-container" class="section level2">
<h2 class="hasAnchor">
<a href="#build-the-container" class="anchor"></a>Build the container</h2>
<p>Call <code><a href="../reference/build_container.html">lambdar::build_container()</a></code>.</p>
</div>
<div id="upload-to-aws" class="section level2">
<h2 class="hasAnchor">
<a href="#upload-to-aws" class="anchor"></a>Upload to AWS</h2>
<p>You need to upload your freshly-built container to the AWS Elastic Container Registry so that we can use it as a base for our lambda function.</p>
<div id="create-a-container-repository" class="section level3">
<h3 class="hasAnchor">
<a href="#create-a-container-repository" class="anchor"></a>Create a container repository</h3>
<p>You need to create a container repository for each container image. Here I’m calling it <code>lambdar-test</code>, but you can give it whatever name you like.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a>$ <span class="ex">aws</span> ecr create-repository --repository-name lambdar-test</span></code></pre></div>
</div>
<div id="tag-the-container" class="section level3">
<h3 class="hasAnchor">
<a href="#tag-the-container" class="anchor"></a>Tag the container</h3>
<p>The container needs to be tagged with a specific format:</p>
<pre><code>&lt;aws-account-id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/&lt;repository-name&gt;:&lt;optional-tag&gt;</code></pre>
<p>The <code>&lt;repository-name&gt;</code> must match the name of the repository created earlier. If you omit the <code>&lt;optional-tag&gt;</code>, AWS will tag it with <code>:latest</code>.</p>
<p>Using a fake AWS account ID and the <code>ap-southeast-2</code> region (I’m in New Zealand), the whole tag becomes <code>123456789012.dkr.ecr.ap-southeast-2.amazonaws.com/lambdar-test:latest</code>.</p>
<p>Then, use this awful command to upload the image</p>
<pre><code>$ aws ecr get-login-password | docker login --username AWS --password-stdin 123456789012.dkr.ecr.ap-southeast-2.amazonaws.com</code></pre>
<p>This authenticates Docker with AWS ECR. Now we can finally push the image:</p>
<pre><code>$ docker push 123456789012.dkr.ecr.ap-southeast-2.amazonaws.com/lambdar-test:latest</code></pre>
<p>Now that the image is safely within AWS’s loving embrace we can (finally) use it to create a lambda.</p>
</div>
</div>
<div id="create-the-lambda" class="section level2">
<h2 class="hasAnchor">
<a href="#create-the-lambda" class="anchor"></a>Create the lambda</h2>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lewin Appleton-Fox.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
