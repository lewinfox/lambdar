<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tools for building AWS Lambda functions in R • lambdar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Tools for building AWS Lambda functions in R">
<meta property="og:description" content="Provides an R runtime for AWS lambda and tooling to build,
    test and deploy container-based lambda functions.">
<meta property="og:image" content="https://lewinfox.github.io/lambdar/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">lambdar</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0.9008</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/configuration.html">Configuring lambdar</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lewinfox/lambdar/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="lambdar-" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#lambdar-" class="anchor"></a>lambdar <a href="https://lewinfox.github.io/lambdar"><img src="reference/figures/logo.png" align="right" height="138"></a>
</h1></div>
<!-- badges: start -->
<!-- badges: end -->
<p>The goal of lambdar is to make it easy to run R on AWS lambda. AWS doesn’t provide support for R out of the box, but <em>does</em> allow you to provide a custom runtime in the form of a container image or lambda layers. Lambdar provides:</p>
<ul>
<li>An R runtime (thanks to <a href="https://github.com/mdneuzerling/r-on-lambda">mdneuzerling/r-on-lambda</a>)</li>
<li>Tools to build, test and deploy Docker containers containing your code</li>
</ul>
<p>The process is simple. You write your code as normal, decorate your lambda function with a roxygen-style <code>@lambda</code> tag, and lambdar does the rest. It’s designed to drop on top of your existing work with almost no changes to your code.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the development version from GitHub with</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"lewinfox/lambdar"</span><span class="op">)</span></code></pre></div>
<p><a href="https://docs.docker.com/get-docker/">Docker</a> and the <a href="https://aws.amazon.com/cli/">AWS cli</a> are recommended - without these lambdar can build Dockerfiles but can’t create or deploy the actual image.</p>
</div>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>Lambdar is designed to work in <a href="https://r4ds.had.co.nz/workflow-projects.html">R projects</a>. For this example I’ve create a project in a directory called <code>lambdar-test</code>. The project contains one file, <code>main.R</code>, which contains one function, <code>hello_world()</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># main.R</span>

<span class="co">#' @lambda</span>
<span class="va">hello_world</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"World"</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello, "</span>, <span class="va">name</span>, <span class="st">"!"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="generate-config-file" class="section level2">
<h2 class="hasAnchor">
<a href="#generate-config-file" class="anchor"></a>Generate config file</h2>
<p>Call <code><a href="reference/init.html">lambdar::init()</a></code>. This will create the following in your project’s root directory:</p>
<ol>
<li>A <code>_lambdar.yml</code> file. This will be pre-populated with some metadata about your app. For this example you can leave it as-is.</li>
<li>A <code>.lambdar/</code> directory containing a single file, <code>lambdar_runtime.R</code>. This is the custom runtime that will be installed into the container to make everything work. Don’t touch it!</li>
<li>A <code>.dockerignore</code> file, which lists the files and folders that should <em>not</em> be copied into the final container image.</li>
</ol>
<p>Lambdar also scans all the R files in your project looking for:</p>
<ul>
<li>Functions with <code>@lambda</code> tags (referred to as “handler functions”)s</li>
<li>R package dependencies</li>
</ul>
<p>and writes this information int <code>_lambdar.yml</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">lambdar</span><span class="fu">::</span><span class="fu"><a href="reference/init.html">init</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; ✔ Setting active project to '/home/lewin/lambdar-test'</span>
<span class="co">#&gt; ✔ Creating .lambdar directory</span>
<span class="co">#&gt; ✔ Writing .lambdar/lambdar_runtime.R</span>
<span class="co">#&gt; ✔ Writing '.dockerignore'</span>
<span class="co">#&gt; ℹ Scanning project...</span>
<span class="co">#&gt; ✔ Found 1 handler function</span>
<span class="co">#&gt; ✔ Writing '_lambdar.yml'</span></code></pre></div>
<p>If you change your code (for example, adding new package dependencies or changing which function is tagged with <code>@lambda</code>), call <code><a href="reference/build_config.html">lambdar::build_config()</a></code> to re-scan your code and update <code>_lambdar.yml</code>.</p>
</div>
<div id="edit-_lambdaryml" class="section level2">
<h2 class="hasAnchor">
<a href="#edit-_lambdaryml" class="anchor"></a>Edit <code>_lambdar.yml</code>
</h2>
<p>If you have an AWS account, add your AWS account ID and region to <code>_lambdar.yml</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># _lambdar.yml</span></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># Your 12-digit AWS ID</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="fu">aws_account_id</span><span class="kw">:</span><span class="at"> </span><span class="st">"123456789012"</span></span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># Your preferred AWS region e.g. "ap-southeast-2"</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="fu">aws_region</span><span class="kw">:</span><span class="at"> </span><span class="st">"ap-southeast-2"</span></span></code></pre></div>
<p>For more information on the different configuration options see <code><a href="articles/configuration.html">vignette("configuration")</a></code>.</p>
</div>
<div id="build-the-image" class="section level2">
<h2 class="hasAnchor">
<a href="#build-the-image" class="anchor"></a>Build the image</h2>
<p>From here you can call <code><a href="reference/build_dockerfile.html">lambdar::build_dockerfile()</a></code> or <code><a href="reference/build_image.html">lambdar::build_image()</a></code>. <code><a href="reference/build_image.html">build_image()</a></code> builds the Dockerfile as part of the process anyway, but if you want to review the Dockerfile before building it, use <code><a href="reference/build_dockerfile.html">build_dockerfile()</a></code>. The Dockerfile will be created in your project’s root directory.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">lambdar</span><span class="fu">::</span><span class="fu"><a href="reference/build_dockerfile.html">build_dockerfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; ✔ Setting active project to '/home/lewin/lambdar-test'</span>
<span class="co">#&gt; ✔ Writing 'Dockerfile'</span>
<span class="co">#&gt; ℹ To build your container, run `docker build -t lambdar-test .` or `lambdar::build_image()`</span></code></pre></div>
<p>Or</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">lambdar</span><span class="fu">::</span><span class="fu"><a href="reference/build_image.html">build_image</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; → `docker build -t lambdar-test .`</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; ... [lots of Docker output] ...</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; ✓ Docker build successful</span>
<span class="co">#&gt; ℹ To start your container run `docker run -p 9000:8080 lambdar-test main.hello_world`</span>
<span class="co">#&gt; ℹ Once running you can send test queries to `http://localhost:9000/2015-03-31/functions/function/invocations`</span></code></pre></div>
</div>
<div id="test-locally" class="section level2">
<h2 class="hasAnchor">
<a href="#test-locally" class="anchor"></a>Test locally</h2>
<p>The built container is based on an image supplied by AWS that includes a copy of something called the Runtime Interface Emulator (RIE) that simulates the environment your function will run in. This means you can work out the bugs in your function before deploying to AWS.</p>
<p>To start a container locally, use the Docker run command from the previous step.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">docker</span> run -p 9000:8080 lambdar-test main.hello_world</span></code></pre></div>
<p>In case you’re not familiar with Docker syntax, this means “run the <code>lambdar-test</code> container, redirecting traffic from local port 9000 to container port 8080”. <code>"main.hello_world"</code> is a required parameter that tells the Lambda runtime which handler we want this container to use. In this case we’re using the <code>hello_world()</code> function from the <code>main.R</code> file.</p>
<p>You can now query the demo endpoint using the tool of your choice to test your API.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a>$ <span class="ex">curl</span> http://localhost:9000/2015-03-31/functions/function/invocations</span>
<span id="cb8-2"><a href="#cb8-2"></a>{<span class="st">"result"</span>: <span class="st">"Hello, World!"</span>, <span class="st">"status"</span>: <span class="st">"success"</span>}</span></code></pre></div>
<p>If your function accepts arguments, you can pass in a JSON payload:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a>$ <span class="ex">curl</span> http://localhost:9000/2015-03-31/functions/function/invocations -d <span class="st">'{"name": "R"}'</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>{<span class="st">"result"</span>: <span class="st">"Hello, R!"</span>, <span class="st">"status"</span>: <span class="st">"success"</span>}</span></code></pre></div>
<p><strong>NOTE</strong>: All parameters from the JSON payload are passed to your function as text. If your function expects any other input it needs to perform the conversion itself. For example:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># main.R</span>

<span class="co">#' @lambda</span>
<span class="va">add_one</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="co"># You should also add some error handling in case this fails</span>
  <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span>
<span class="op">}</span> </code></pre></div>
<p>To stop your container use <code>docker stop</code>. If you have no other containers running you can use</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="ex">docker</span> stop <span class="va">$(</span><span class="ex">docker</span> ps -q<span class="va">)</span></span></code></pre></div>
</div>
<div id="upload-to-aws" class="section level2">
<h2 class="hasAnchor">
<a href="#upload-to-aws" class="anchor"></a>Upload to AWS</h2>
<p>Once you’ve tested your function it’s time to upload it to the AWS Elastic Container Registry. You can do this by hand following <a href="https://aws.amazon.com/blogs/aws/new-for-aws-lambda-container-image-support/">this guide</a>, or you can use <code><a href="reference/upload_to_ecr.html">lambdar::upload_to_ecr()</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">lambdar</span><span class="fu">::</span><span class="fu"><a href="reference/upload_to_ecr.html">upload_to_ecr</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; ✔ Setting active project to '/home/lewin/lambdar-test'</span>
<span class="co">#&gt; → `docker tag lambdar-test 123456789012.dkr.ecr.ap-southeast-2.amazonaws.com/lambdar-test:latest`</span>
<span class="co">#&gt; ✔ Suggessfully tagged `lambdar-test` as `123456789012.dkr.ecr.ap-southeast-2.amazonaws.com/lambdar-test:latest`</span>
<span class="co">#&gt; ℹ Creating the repository if it doesn't already exist</span>
<span class="co">#&gt; → `aws ecr create-repository --repository-name lambdar-test`</span>
<span class="co">#&gt; ℹ Authenticating Docker with AWS ECR</span>
<span class="co">#&gt; → `aws ecr get-login-password | docker login --username AWS --password-stdin 123456789012.dkr.ecr.ap-southeast-2.amazonaws.com`</span>
<span class="co">#&gt; ℹ Uploading container image</span>
<span class="co">#&gt; → `docker push 123456789012.dkr.ecr.ap-southeast-2.amazonaws.com/lambdar-test:latest`</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; ... [lots of output] ...</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; ✔ Successfully uploaded 123456789012.dkr.ecr.ap-southeast-2.amazonaws.com/lambdar-test:latest</span></code></pre></div>
</div>
<div id="create-your-lambda-function" class="section level2">
<h2 class="hasAnchor">
<a href="#create-your-lambda-function" class="anchor"></a>Create your lambda function</h2>
<p>Create your lambda function from your newly-uploaded container image following the steps <a href="https://aws.amazon.com/blogs/aws/new-for-aws-lambda-container-image-support/">here</a>.</p>
</div>
<div id="todo---future-work" class="section level2">
<h2 class="hasAnchor">
<a href="#todo---future-work" class="anchor"></a>TODO - future work</h2>
<ul>
<li>Add a function to create the lambda for you.</li>
<li>Provide a GitHub Actions template so we can update on every push etc.</li>
<li>Duplicate the same functionality but using lambda layers (the other custom runtime option). See <a href="https://medium.com/bakdata/running-r-on-aws-lambda-9d40643551a6">medium.com/bakdata/running-r-on-aws-lambda</a>.</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/lewinfox/lambdar/">https://​github.com/​lewinfox/​lambdar/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/lewinfox/lambdar/issues">https://​github.com/​lewinfox/​lambdar/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Lewin Appleton-Fox <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by Lewin Appleton-Fox.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
